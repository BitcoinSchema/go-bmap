package bmap

import (
	"testing"

	"github.com/bitcoinschema/go-b"
	"github.com/bitcoinschema/go-bap"
	"github.com/bitcoinschema/go-bitcoin/v2"
	"github.com/bitcoinschema/go-bmap/run"
	"github.com/bitcoinschema/go-bmap/sfp"
	"github.com/bitcoinschema/go-bmap/test"
	"github.com/bitcoinschema/go-bob"
	"github.com/bitcoinschema/go-bpu"
	magic "github.com/bitcoinschema/go-map"
)

var cryptofights = "cryptofights"
var something = "something"

func TestFromBob(t *testing.T) {

	dataSource := `{"_id":"5ebc04c7814c6a17a6c90b3b","tx":{"h":"ce7429a101b7aecdf1e5449151d0be17a3948cb5c22282832ae942107edb2272"},"in":[{"i":0,"tape":[{"cell":[{"b":"MEQCIDUGRtDdmf2I2p1vcA2s4fMuBcmnSi5kOI2chSiFrYQKAiAq8XSIx8EbM2oKJJC9t/SFXTGnJBfE7mRKdGOVR7zIB0E=","s":"0D\u0002 5\u0006F�ݙ��ڝop\r���.\u0005ɧJ.d8���(���\n\u0002 *�t���\u001b3j\n$����]1�$\u0017��dJtc�G��\u0007A","ii":0,"i":0},{"b":"A/20DJgUWAXROgZTKDRmcC0ja306xpg3SiMTPy3QKhqQ","s":"\u0003��\f�\u0014X\u0005�:\u0006S(4fp-#k}:Ƙ7J#\u0013?-�*\u001a�","ii":1,"i":1}],"i":0}],"e":{"h":"f8448e73fc7667b91f86cf152b9bc4d88c365174989d79871e64ca8c66c1e785","i":0,"a":"1P1dKk7BCB6iTUz13w1eXkLfcj8a8dC4iv"},"seq":4294967295}],"out":[{"i":0,"tape":[{"cell":[{"op":0,"ops":"OP_0","ii":0,"i":0},{"op":106,"ops":"OP_RETURN","ii":1,"i":1}],"i":0},{"cell":[{"b":"MVB1UWE3SzYyTWlLQ3Rzc1NMS3kxa2g1NldXVTdNdFVSNQ==","s":"1PuQa7K62MiKCtssSLKy1kh56WWU7MtUR5","ii":2,"i":0},{"b":"U0VU","s":"SET","ii":3,"i":1},{"b":"YXBw","s":"app","ii":4,"i":2},{"b":"MnBheW1haWw=","s":"2paymail","ii":5,"i":3},{"b":"cGF5bWFpbA==","s":"paymail","ii":6,"i":4},{"b":"aGFnYmFyZEBtb25leWJ1dHRvbi5jb20=","s":"hagbard@moneybutton.com","ii":7,"i":5},{"b":"cHVibGljX2tleQ==","s":"public_key","ii":8,"i":6},{"b":"MDJjODliNjc5MGViNjA1MDYyYTMxZjEyNDI1MDU5NGJkMGZkMDI5ODhkYTI1NDFiM2QyNWU3ZWYzOTM3ZmI0YWUw","s":"02c89b6790eb605062a31f124250594bd0fd02988da2541b3d25e7ef3937fb4ae0","ii":9,"i":7},{"b":"cGxhdGZvcm0=","s":"platform","ii":10,"i":8},{"b":"dHdpdHRlcg==","s":"twitter","ii":11,"i":9},{"b":"cHJvb2ZfdXJs","s":"proof_url","ii":12,"i":10},{"b":"aHR0cHM6Ly90d2l0dGVyLmNvbS9oYWdiYXJkZGQvc3RhdHVzLzEyMDUxODk1ODAzMDkzNzcwMjQ=","s":"https://twitter.com/hagbarddd/status/1205189580309377024","ii":13,"i":11},{"b":"cHJvb2ZfYm9keQ==","s":"proof_body","ii":14,"i":12},{"b":"SGkKCk15IHBheW1haWwgaXMgaGFnYmFyZEBtb25leWJ1dHRvbi5jb20=","s":"Hi\n\nMy paymail is hagbard@moneybutton.com","ii":15,"i":13},{"b":"cHJvb2ZfaWQ=","s":"proof_id","ii":16,"i":14},{"b":"Sms5dlFncGREcG9XMHFEWQ==","s":"Jk9vQgpdDpoW0qDY","ii":17,"i":15}],"i":1},{"cell":[{"b":"MXNpZ255Q2l6cDFWeUJzSjVTczJ0RUFndzd6Q1lOSnU0","s":"1signyCizp1VyBsJ5Ss2tEAgw7zCYNJu4","ii":19,"i":0},{"b":"SU5LRmIxNU1uQVhxTlFueStiNEtBVm5HTnR5bUcwZEhTdTEzKzg3MSt0aTBXTjVGQmVBLzdEZ1VuMXRsdzZGN29kYlc3SURyVmVQS1RMclRQQWlEcXlvPQ==","s":"INKFb15MnAXqNQny+b4KAVnGNtymG0dHSu13+871+ti0WN5FBeA/7DgUn1tlw6F7odbW7IDrVePKTLrTPAiDqyo=","ii":20,"i":1},{"b":"MDJjODliNjc5MGViNjA1MDYyYTMxZjEyNDI1MDU5NGJkMGZkMDI5ODhkYTI1NDFiM2QyNWU3ZWYzOTM3ZmI0YWUw","s":"02c89b6790eb605062a31f124250594bd0fd02988da2541b3d25e7ef3937fb4ae0","ii":21,"i":2},{"b":"aGFnYmFyZEBtb25leWJ1dHRvbi5jb20=","s":"hagbard@moneybutton.com","ii":22,"i":3}],"i":2}],"e":{"v":0,"i":0,"a":"false"}},{"i":1,"tape":[{"cell":[{"op":118,"ops":"OP_DUP","ii":0,"i":0},{"op":169,"ops":"OP_HASH160","ii":1,"i":1},{"b":"7njcAgMt9eekcx5JZXFDoaThy9M=","s":"�x�\u0002\u0003-��s\u001eIeqC�����","ii":2,"i":2},{"op":136,"ops":"OP_EQUALVERIFY","ii":3,"i":3},{"op":172,"ops":"OP_CHECKSIG","ii":4,"i":4}],"i":0}],"e":{"v":31202,"i":1,"a":"1Njvc7dj8UHG6hnV5k5ZjSJtPgTofknDmx"}}],"lock":0,"blk":{"i":618112,"h":"000000000000000001e1e1f2995c9ba2e316f6fb85c247c923c591e56ea00fb6","t":1579328162},"i":478}`

	bobData, err := bob.NewFromString(dataSource)
	if err != nil {
		t.Fatalf("failed to create bob tx %s", err)
	}

	var bmapData *Tx
	if bmapData, err = NewFromBob(bobData); err != nil {
		t.Fatalf("error occurred: %s", err)
	}

	if bmapData.Tx.H != "ce7429a101b7aecdf1e5449151d0be17a3948cb5c22282832ae942107edb2272" {
		t.Fatalf("inherited field failed %+v", bmapData.MAP)
	}

	mapData := bmapData.MAP
	if mapData["app"] != "2paymail" {
		t.Fatalf("test fromBob failed %+v", mapData)
	}

}

func TestFromTx(t *testing.T) {

	t.Run("error", func(t *testing.T) {
		tx := ""
		_, err := NewFromTx(tx)
		if err == nil {
			t.Fatalf("error should occur")
		}
	})

	t.Run("success", func(t *testing.T) {
		tx := "01000000018952fe8892c429e69feb9b2dd9cd1f12ed757dc62e8d628b5a215f78ed895374020000006a47304402204784632fabca0f4aaa05dd6983633b2e8bf708d8766d0385f3393fff0623b88c02201a760e144116d47967501c2ea50dc231ae57c0eb78769d63713ce0648025c820412103221cb24c4e8b05a58bcf2ee8411f62e337c8099c8646babd47d0960899f69acaffffffff04680b0000000000001976a91409cc4559bdcb84cb35c107743f0dbb10d66679cc88ac0f720000000000001976a9146b1fe7b2063aa07766c764c0796fd4efd00340f288ac8a893b00000000001976a914be5f62df829ef754b8be09b37b04c4e7f9ff59d588ac0000000000000000ad006a223150755161374b36324d694b43747373534c4b79316b683536575755374d74555235035345540361707008746f6e6963706f7704747970650b6f666665725f636c69636b0f6f666665725f636f6e6669675f696403383038106f666665725f73657373696f6e5f6964403464303537386561643432393266653163643163393936643931623534613130653333653334623031396231386330613564353730376461346461346437653900000000"
		bmapData, err := NewFromTx(tx)
		if err != nil {
			t.Fatalf("error occurred: %s", err)
		}

		if bmapData.Tx.H != "1817ecc5b3207d9b33014b461688477146139105f198d69efadc73d05cfd3ed8" {
			t.Fatalf("inherited field failed %+v", bmapData.MAP)
		}

		mapData := bmapData.MAP
		if mapData["app"] != "tonicpow" {
			t.Fatalf("test fromTx failed %+v", mapData)
		}
	})

	t.Run("run + non standard", func(t *testing.T) {
		tx := "01000000023df0e0c5933a28f8a60572588aa2073ebe6297b48e3196e2c404a6869e45eb0d020000006b483045022100e349bcbf4002426a472daf2c02921c7a98d01f5462ae66eaf2bac0973a37033a02203c35870bcf7febbbe5e75a90a86918153eea8b8976f5546871b50c7674c9c1154121024ee11d705c041678b7fe9b34490c099fb7ae915e4267ecbe290874f0fc1863b3ffffffff4e32d8d868b6fd280b7af6a70e008f0c05f769b5263ff81c63092ec32a8ba159040000006a47304402203f8236b23b50f758dad4522acb793f73305aa1efda1ab7b305facf09665eae91022049366bad7e887aecd45f2cdafec4a3b21c3f880431fe142809450981881fcf7b41210361e9371c81d97f869d51e6909eb1132fc6c55b2caa8c4cea6d06a4f99b446decffffffff0422020000000000001976a9145a468879d2c7f3d48e6664a76286c96653a8ed4488ac0000000000000000fd9d03006a0372756e01050972656c6179782e696f4d88037b22696e223a312c22726566223a5b22643631373030323561363232343864386466366463313465333830366536386238646633643830346338303063376266623233623062343233323836323530355f6f31222c22656162396666366464316165383230363535343635356537653130613766323161613039653232613462386634643034386661353431633137393764633735655f6f31222c22373261363165623939306666646236623338653566393535653139346665643566663662303134663735616336383233353339636535363133616561306265385f6f31222c22373237653762343233623765653430633062356265383766626137666135363733656132643230613734323539303430613732393564396333326139303031315f6f31222c22383162636566323962306534656437343566333432326330623736346133336337366430333638616632643265376464313339646238653030656533643861365f6f31222c22343931343536393336373661663735363765626532303637316335636230313336396163373838633230663362316338303466363234613165646131386633665f6f31222c22336237656634313131383562626533643031636165616462653666313135623031303361353436633465663061633734373461613666626237316166663230385f6f31225d2c226f7574223a5b2230323164363634333831613532306434636439383732373638333866356339336661353763393835626631356134633739656537633932643931396437373263225d2c2264656c223a5b2237306163303437613037383638643562636538333130633530383637623631313639373534346134386165353161353931356339643163636536303766383236225d2c22637265223a5b7b2224617262223a7b2261646472657373223a2231424b4475665758434b6672714b6e75465664524668554d4a4733654c6b77483767222c227361746f73686973223a31343030303030307d2c2254223a7b22246a6967223a317d7d5d2c2265786563223a5b7b226f70223a2243414c4c222c2264617461223a5b7b22246a6967223a307d2c2273656e64222c5b7b2224617262223a7b2261646472657373223a2231424b4475665758434b6672714b6e75465664524668554d4a4733654c6b77483767222c227361746f73686973223a31343030303030307d2c2254223a7b22246a6967223a317d7d2c355d5d7d5d7d8705000000000000fd100320b88bf03d21d88541df8c758a1da474c783f7c362c9daf2670229d9d55ef8226a01c35279630142517a75547901687f7501447f77007901207f7504000000007e517951797e56797eaa577901247f75547f77876975756754795579827758947f75557982770128947f77527987696861547921cdb285cc49e5ff3eed6536e7b426e8a528b05bf9276bd05431a671743e651ceb002102dca1e194dd541a47f4c85fea6a4d45bb50f16ed2fddc391bf80b525454f8b40920f941a26b1c1802eaa09109701e4e632e1ef730b0b68c9517e7c19be2ba4c7d37202f282d163597a82d72c263b004695297aecb4d758dccd1dbf61e82a3360bde2c202cde0b36a3821ef6dbd1cc8d754dcbae97526904b063c2722da89735162d282f56795679aa616100790079517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e01007e81517a756157795679567956795679537956795479577995939521414136d08c5ed2bf3ba048afe6dcaebafeffffffffffffffffffffffffffffff0061517951795179517997527a75517a5179009f635179517993527a75517a685179517a75517a7561527a75517a517951795296a0630079527994527a75517a68537982775279827754527993517993013051797e527e53797e57797e527e52797e5579517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f517f7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7c7e7e56797e0079517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a75517a756100795779ac517a75517a75517a75517a75517a75517a75517a75517a75517a7561777777777738a20100000000001976a914f4993778efa9207d8f2670348c197dffdfe4f32f88ac00000000"
		bmapData, err := NewFromTx(tx)
		if err != nil {
			t.Fatalf("error occurred: %s", err)
		}

		if bmapData.Tx.H != "a7ccc556170fbafb219990b031839197837fc2bd912928afcc513e0dbf62b54f" {
			t.Fatalf("bmap tx id incorrect %+v", bmapData)
		}

		runData := bmapData.Run
		if runData.Payload.Out[0] != "021d664381a520d4cd987276838f5c93fa57c985bf15a4c79ee7c92d919d772c" {
			t.Fatalf("failed parsing run data %+v", runData)
		}
	})
}

func TestMap(t *testing.T) {

	keyName1 := "keyName1"
	something := something
	keyName2 := something
	somethingElse := "something else"

	tape := bpu.Tape{
		Cell: []bpu.Cell{
			{S: &magic.Prefix},
			{S: &magic.Set},
			{S: &keyName1},
			{S: &something},
			{S: &keyName2},
			{S: &somethingElse},
		},
	}

	m, err := magic.NewFromTape(&tape)
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if m["keyName1"] != something {
		t.Fatalf("SET Failed %s", m["keyName1"])
	}

}

func TestMapFromRawTxString(t *testing.T) {
	bob, err := bob.NewFromRawTxString(`01000000018952fe8892c429e69feb9b2dd9cd1f12ed757dc62e8d628b5a215f78ed895374020000006a47304402204784632fabca0f4aaa05dd6983633b2e8bf708d8766d0385f3393fff0623b88c02201a760e144116d47967501c2ea50dc231ae57c0eb78769d63713ce0648025c820412103221cb24c4e8b05a58bcf2ee8411f62e337c8099c8646babd47d0960899f69acaffffffff04680b0000000000001976a91409cc4559bdcb84cb35c107743f0dbb10d66679cc88ac0f720000000000001976a9146b1fe7b2063aa07766c764c0796fd4efd00340f288ac8a893b00000000001976a914be5f62df829ef754b8be09b37b04c4e7f9ff59d588ac0000000000000000ad006a223150755161374b36324d694b43747373534c4b79316b683536575755374d74555235035345540361707008746f6e6963706f7704747970650b6f666665725f636c69636b0f6f666665725f636f6e6669675f696403383038106f666665725f73657373696f6e5f6964403464303537386561643432393266653163643163393936643931623534613130653333653334623031396231386330613564353730376461346461346437653900000000`)
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	}

	m, err := magic.NewFromTape(&bob.Out[3].Tape[1])
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if m["CMD"] != "SET" && m["app"] != "tonicpow" {
		t.Fatalf("SET Failed %v", m)
	}
}

func TestRun(t *testing.T) {
	r := "run"
	zero5 := "05"
	data := "{\"in\":5,\"ref\":[\"303ab9e7941ad08482f876a4501116c57a2f3eacf8608b3de235525daf81b357_o1\",\"c2c4c971e85b499c29a8ab2148fd324fe12b550b8f4f57658a4686e011d8fd58_o1\",\"cfa749424a1547a169d0b8fc0a54fed8918d2cf46eeea242fd2aebe3c8875a3c_o1\",\"a9082e00bbedfc80986c7821ed0b2a81dd34ad6bbd2a07fd9e5a06394614a957_o1\",\"705d8340b64e73fa9758e7f7799d28da38669fe0e2cb1ce1960abb1a6a26acf3_o1\",\"92f78b159c4e51ad52ed6d041d2253c2683d95d63a1568e3ce1e8ea516bfb962_o1\",\"08f34f29fd07850ca66973784362927523ea7940084fbd3690676b81628f8c07_o1\",\"d67bf5454d02dafcb4350e65899d890a0660e51442dc0c0f6f7b256a85d19eac_o1\",\"14e278c68ff521e0916ad7c713ae4a0156e76361dbd3b2b357dfb6028e0dca7a_o1\",\"01b37806b3ef4d45f0a73bfe10e916d4f280f9628569765e638259afeb15da16_o1\",\"918d80459b2469381fa493c10bb42d0cdca465170b9d8f88d7c85c55940b8bbc_o1\",\"a78f5a6d72f78711e66c6211fbbd0a0bfd15ad91bdd00404928a9facc63da6d9_o1\",\"74a9d9eddee3fada42489b9db04ef362043225d70799cbfa32a0fc425892ad31_o1\",\"3a67cec3c16bdb847b972bee2fc1c0717c59edcae7bf5f48c91feccfa635af33_o1\",\"382713c2b7abf570b1d344ebcf6b7896d8c5d8fd6362735c5fe72ed793829670_o1\"],\"out\":[\"e0eceb4e317aee7e68e39f22724bb6242c6b79e00483cb4b0250469235bb1ce8\",\"6720ce1b1eeb8401a4258aaab51be88f947744b935c9d7d7eed7c1e8306c8dd3\",\"dee4f6758363d2adfb614783305f6135c13f47772231dbb318d795c5d64d2fac\",\"add7d36d4ab36b1b2e922aa0a21500f3e1a89cd99b80a91acc75ffadd9ee248b\",\"fd86dc04c8a6657e3643a6eaa23892a89e87c481243effb3a22b8e118928e103\",\"df77a80e8a1a950a2cbf6dcc717a7ee461e741d8350edb6fb7aaa35fbf59036f\"],\"del\":[],\"cre\":[\"03107feff22788a1fc8357240bf450fd7bca4bd45d5f8bac63818c5a7b67b03876\"],\"exec\":[{\"op\":\"NEW\",\"data\":[{\"$jig\":5},[\"03107feff22788a1fc8357240bf450fd7bca4bd45d5f8bac63818c5a7b67b03876\",{\"allowBots\":true,\"fee\":0,\"lobby\":5,\"playerCount\":1,\"reward\":0,\"rulesId\":\"bot5\",\"tier\":3},[{\"fighter\":{\"$jig\":0},\"items\":[{\"$jig\":1},{\"$jig\":2},{\"$und\":1},{\"$jig\":3}],\"owner\":\"1Pm9cCc9RnZnAdqbKnXgqbeauRa5nfAejz\",\"pubkey\":\"038630f8220616856e7ebb73847643b4fe39fdcb4d7145b687ed1bb78340c77e08\",\"skills\":[{\"$jig\":7},{\"$jig\":8},{\"$jig\":9},{\"$jig\":10}],\"tags\":[],\"userId\":\"exgen\"},{\"coins\":[],\"fighter\":{\"$jig\":4},\"items\":[],\"pubkey\":\"02c74b8db80b5af8dc9fe14fdc098d3b7073184485471df9cf243330ae8da67a98\",\"skills\":[{\"$dup\":[\"1\",\"2\",\"0\",\"skills\",\"0\"]}],\"tags\":[\"bot\"],\"userId\":\"cryptofights\"}],\"14ad8af5a501229178217f8f85d698fef13ecaa56c80778cc9d9b1faade4030f\",1622457372560]]}]}"
	tape := bpu.Tape{
		Cell: []bpu.Cell{
			{S: &r},
			{H: &zero5},
			{S: &cryptofights},
			{S: &data},
		},
	}

	runTx, err := run.NewFromTape(tape)
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if runTx.AppID != cryptofights {
		t.Fatalf("Unexpected data %s %s", runTx.AppID, err)
	}

}

func TestRunFromTx(t *testing.T) {
	rawTx := "01000000012f92dc3a6c88a574503dc67302bfafc02753e4a35939d25d628855e63a16e217020000006b4830450221009da02e3fb4e758f786fe0713c83eb4cc0dd4fe7cadfcfadfcec67b92534cddd6022029ea80e3b016d8b26970a720c20bc79d3f10bdeb49c7e00e37248336a69b2cd1412103b37a603250b7e37ea6515f01749d9dc58e4723875011370a1abd3f1537ca38cfffffffff030000000000000000fd131f006a0372756e01050c63727970746f6669676874734dfb1e7b22696e223a302c22726566223a5b22323237373530643430303665323939306464346236633239356439306332353538663130663235623032343436373737623130666361303866353565343862335f6f31222c22656366393231306166333535353165643737313965396635316235616265366464633339336162346161373765656462346633336334316465666465383531305f6f31222c22373461396439656464656533666164613432343839623964623034656633363230343332323564373037393963626661333261306663343235383932616433315f6f31222c22373830616131306132323335333235353033383331373364303431343837323531366263323431613735343233643535366631636235373136356138383735645f6f31222c22333832373133633262376162663537306231643334346562636636623738393664386335643866643633363237333563356665373265643739333832393637305f6f31222c22613738663561366437326637383731316536366336323131666262643061306266643135616439316264643030343034393238613966616363363364613664395f6f31222c22313465323738633638666635323165303931366164376337313361653461303135366537363336316462643362326233353764666236303238653064636137615f6f31222c22643637626635343534643032646166636234333530653635383939643839306130363630653531343432646330633066366637623235366138356431396561635f6f31222c22633263346339373165383562343939633239613861623231343866643332346665313262353530623866346635373635386134363836653031316438666435385f6f31222c22336136376365633363313662646238343762393732626565326663316330373137633539656463616537626635663438633931666563636661363335616633335f6f31222c22373166626133383633343162393332333830656335626665646333613430626365343364343937346465636463393463343139613934613863653564666332335f6f31222c22333430643437633238613262386536653836373537653832646130623431323734643333633539663134336431303735316538363364313361396630663531615f6f31225d2c226f7574223a5b2236646132333764343161396638653163646631396335393737383961356661383963636330393430386464616231316537386464373863333231656161626639225d2c2264656c223a5b5d2c22637265223a5b223141467161436751666a3244344371584a46347a7a424d3836596e584b58637458225d2c2265786563223a5b7b226f70223a224445504c4f59222c2264617461223a5b22636c61737320426174746c6520657874656e6473204679784a6967207b5c6e20202020696e69742876616c696461746f722c2072756c65732c20706c61796572732c2069642c2074696d657374616d7029207b5c6e2020202020202020746869732e6964203d20746869732e72616e646f6d203d2069643b5c6e2020202020202020746869732e74696d657374616d70203d2074696d657374616d703b5c6e2020202020202020746869732e72756c6573203d2072756c65733b5c6e5c6e2020202020202020746869732e626174746c65506c6179657273203d20706c61796572732e6d617028706c61796572203d3e20746869732e6a6f696e426174746c6528706c6179657229293b5c6e2020202020202020746869732e626174746c6567726f756e6454696572203d2072756c65732e746965723b5c6e2020202020202020746869732e64696365203d206e65772044696365286964293b5c6e2020202020202020746869732e7374617465203d20426174746c655574696c732e6275696c64426174746c65537461746528746869732e626174746c65506c61796572732c20746869732e64696365293b5c6e5c6e2020202020202020746869732e7475726e436f756e74203d20303b5c6e5c6e2020202020202020746869732e7361746f73686973203d2072756c65732e726577617264207c7c203534363b5c6e5c6e2020202020202020746869732e737461746548617368203d205368613235362e68617368546f486578284a534f4e2e737472696e6769667928746869732e737461746529293b5c6e2020202020202020746869732e737461747573203d20436f6e7374616e74732e5374617475732e4f70656e3b5c6e2020202020202020746869732e7374617465486973746f7279203d205b5d3b5c6e2020202020202020746869732e6163746f72203d20706c61796572735b746869732e73746174652e706c61796572546f4163745d2e7573657249643b5c6e2020202020202020746869732e7374616765203d202763726561746564273b5c6e20202020202020205c6e2020202020202020746869732e6f776e6572203d20746869732e76616c696461746f72203d2076616c696461746f723b5c6e202020207d5c6e5c6e202020206a6f696e426174746c6528706c6179657229207b5c6e2020202020202020636f6e7374207b207573657249642c207075626b65792c206f776e65722c206974656d732c20666967687465722c20736b696c6c732c2074616773207d203d20706c617965723b5c6e20202020202020205c6e2020202020202020696628746869732e72756c65732e66656529207b5c6e20202020202020202020202069662028666967687465722e7361746f73686973203c20746869732e72756c65732e66656529207468726f77206e6577204572726f722827496e73756666696369656e742046696768746572205361746f7368697327293b5c6e202020202020202020202020666967687465722e7365745361746f7368697328666967687465722e7361746f73686973202d20746869732e72756c65732e666565293b5c6e20202020202020207d20656c7365207b5c6e202020202020202020202020666967687465722e6175746828293b5c6e20202020202020207d5c6e20202020202020205c6e20202020202020206974656d732e666f7245616368286974656d203d3e206974656d202626206974656d2e617574682829293b5c6e2020202020202020636f6e7374205b6d61696e68616e642c206f666668616e642c2061726d6f722c206861745d203d206974656d732e6d61702869203d3e206920262620692e6974656d20262620467978436c6173732e64656570436c6f6e6528692e6974656d29293b5c6e5c6e202020202020202072657475726e207b5c6e2020202020202020202020207573657249642c5c6e2020202020202020202020207075626b65792c5c6e2020202020202020202020206f776e65722c5c6e202020202020202020202020666967687465722c5c6e2020202020202020202020206d61696e68616e642c5c6e2020202020202020202020206f666668616e642c5c6e20202020202020202020202061726d6f722c5c6e2020202020202020202020206861742c5c6e202020202020202020202020736b696c6c732c5c6e202020202020202020202020746167733a2074616773207c7c205b5d5c6e20202020202020207d3b5c6e202020207d5c6e5c6e20202020626567696e2874696d656f757429207b5c6e202020202020202069662028746869732e737461676520213d3d2027637265617465642729207468726f77206e6577204572726f722827496e76616c696420537461676527293b5c6e2020202020202020746869732e74696d656f7574203d2074696d656f75743b5c6e202020202020202064656c65746520746869732e73746167653b5c6e2020202020202020746869732e616374696f6e546f6b656e203d206e657720416374696f6e546f6b656e28746869732e6f776e65722c20746869732e626174746c65506c61796572735b746869732e73746174652e706c61796572546f4163745d2e666967687465722e6f776e6572293b5c6e202020207d5c6e5c6e202020207265736f6c76652872616e646f6d2c2074696d657374616d702c2074696d656f757429207b5c6e20202020202020202f2f20636f6e736f6c652e6c6f6728275265736f6c7665272c20746869732e6c6f636174696f6e293b5c6e202020202020202069662028746869732e73746174757320213d3d20436f6e7374616e74732e5374617475732e4f70656e29207468726f77206e6577204572726f722827496e76616c69642053746174757327293b5c6e20202020202020206966202821426174746c655574696c732e76616c696461746552616e646f6d2872616e646f6d2c20746869732e72616e646f6d2929207468726f77206e6577204572726f722827496e76616c69642052616e646f6d27293b5c6e2020202020202020746869732e72616e646f6d203d2072616e646f6d3b5c6e20202020202020205c6e2020202020202020746869732e7374617465486973746f72795b746869732e7475726e436f756e745d203d20746869732e676574537461746528293b5c6e2020202020202020636f6e7374207374617465203d20467978436c6173732e64656570436c6f6e6528746869732e7374617465293b5c6e202020202020202073746174652e616374696f6e4c6f6773203d205b5d3b5c6e2020202020202020746869732e64696365203d206e657720446963652872616e646f6d293b5c6e2020202020202020636f6e737420616374696f6e496e646578203d20746869732e616374696f6e546f6b656e2e616374696f6e496e6465783b5c6e20202020202020206966202874696d657374616d70203c20746869732e74696d656f757429207b5c6e20202020202020202020202069662028616374696f6e496e646578203d3d3d202d31207c7c20616374696f6e496e646578203d3d3d20756e646566696e656429207b5c6e20202020202020202020202020202020746869732e7374617465203d20426174746c655574696c732e736b69705475726e28746869732c2073746174652c20746869732e646963652c2074696d657374616d70293b5c6e2020202020202020202020207d20656c7365207b5c6e20202020202020202020202020202020746869732e616374696f6e546f6b656e2e64657374726f7928293b5c6e20202020202020202020202020202020636f6e73742061747461636b6572203d20746869732e626174746c65506c61796572735b746869732e73746174652e706c61796572546f4163745d3b5c6e20202020202020202020202020202020636f6e737420736b696c6c203d2061747461636b65722e736b696c6c735b616374696f6e496e6465785d3b5c6e202020202020202020202020202020206966202821736b696c6c29207468726f77206e6577204572726f722860247b61747461636b65722e666967687465722e646973706c61794e616d657d207573656420616e20696e76616c696420536b696c6c2049443a20247b616374696f6e496e6465787d60293b5c6e20202020202020202020202020202020746869732e7374617465203d20736b696c6c2e72756e28746869732c2073746174652c20746869732e646963652c2074696d657374616d70293b5c6e2020202020202020202020207d5c6e20202020202020207d20656c7365207b5c6e202020202020202020202020746869732e7374617465203d20426174746c655574696c732e736b69705475726e28746869732c2073746174652c20746869732e646963652c2074696d657374616d70293b5c6e20202020202020207d5c6e5c6e2020202020202020746869732e737461747573203d20746869732e73746174652e7374617475733b5c6e2020202020202020746869732e74696d657374616d70203d2074696d657374616d703b5c6e2020202020202020746869732e74696d656f7574203d2074696d656f75743b5c6e2020202020202020746869732e5f656e645475726e28293b5c6e202020207d5c6e5c6e20202020666f7266656974286d6573736167652c2074696d657374616d7029207b5c6e202020202020202069662028746869732e73746174757320213d3d20436f6e7374616e74732e5374617475732e4f70656e29207468726f77206e6577204572726f722827496e76616c69642053746174757327293b5c6e2020202020202020746869732e7374617465486973746f72795b746869732e7475726e436f756e745d203d20746869732e676574537461746528293b5c6e2020202020202020636f6e737420706c61796572496e646578203d20746869732e626174746c65506c61796572732e66696e64496e6465782870203d3e20702e757365724964203d3d3d206d6573736167652e66726f6d293b5c6e2020202020202020636f6e737420706c61796572203d20746869732e626174746c65506c61796572735b706c61796572496e6465785d3b5c6e2020202020202020636f6e737420766963746f72496e646578203d20746869732e626174746c65506c61796572732e66696e64496e6465782870203d3e20702e75736572496420213d3d206d6573736167652e66726f6d293b5c6e2020202020202020636f6e737420766963746f72203d20746869732e626174746c65506c61796572735b766963746f72496e6465785d3b5c6e20202020202020205c6e2020202020202020636f6e7374207374617465203d20467978436c6173732e64656570436c6f6e6528746869732e7374617465293b5c6e202020202020202073746174652e766963746f72203d207b5c6e2020202020202020202020207075626b65793a20766963746f722e7075626b65792c5c6e2020202020202020202020206f776e65723a20766963746f722e6f776e65722c5c6e202020202020202020202020666967687465723a20766963746f722e666967687465722c5c6e2020202020202020202020207573657249643a20766963746f722e7573657249645c6e20202020202020207d3b5c6e202020202020202073746174652e616374696f6e4c6f6773203d205b7b5c6e202020202020202020202020706c61796572496e6465783a20706c61796572496e6465782c5c6e202020202020202020202020616374696f6e4c6f674d6573736167653a20603c6772616469656e743d21706c61796572247b706c61796572496e6465787d2d636f6c6f723e3c623e247b706c617965722e666967687465722e6d657461646174612e6e616d652e746f55707065724361736528297d3c2f623e203c6772616469656e743d216c6f672d636f6c6f723e20466f72666569746564605c6e20202020202020207d5d3b5c6e202020202020202073746174652e706c61796572546f416374203d20766963746f72496e6465783b5c6e202020202020202073746174652e737461747573203d20436f6e7374616e74732e5374617475732e466f72666569743b5c6e2020202020202020746869732e7374617465203d2073746174653b5c6e5c6e2020202020202020746869732e737461747573203d20746869732e73746174652e7374617475733b5c6e2020202020202020746869732e74696d657374616d70203d2074696d657374616d703b5c6e2020202020202020746869732e5f656e645475726e28293b5c6e202020207d5c6e5c6e202020205f656e645475726e2829207b5c6e202020202020202069662028746869732e737461747573203d3d3d20436f6e7374616e74732e5374617475732e4f70656e29207b5c6e202020202020202020202020746869732e616374696f6e546f6b656e203d206e657720416374696f6e546f6b656e28746869732e6f776e65722c20746869732e626174746c65506c61796572735b746869732e73746174652e706c61796572546f4163745d2e666967687465722e6f776e6572293b5c6e20202020202020207d20656c7365207b5c6e202020202020202020202020746869732e766963746f72203d207b2e2e2e746869732e626174746c65506c61796572735b746869732e73746174652e706c61796572546f4163745d7d3b5c6e20202020202020207d5c6e2020202020202020746869732e7475726e436f756e742b2b3b5c6e2020202020202020746869732e737461746548617368203d205368613235362e68617368546f486578284a534f4e2e737472696e6769667928746869732e737461746529293b5c6e2020202020202020746869732e6163746f72203d20746869732e626174746c65506c61796572735b746869732e73746174652e706c61796572546f4163745d2e7573657249643b5c6e202020207d5c6e5c6e2020202066696e616c697a652829207b5c6e2020202020202020746869732e7374617465486973746f72795b746869732e7475726e436f756e745d203d20746869732e676574537461746528293b5c6e2020202020202020696628215b436f6e7374616e74732e5374617475732e436f6d706c6574652c20436f6e7374616e74732e5374617475732e466f72666569745d2e696e636c7564657328746869732e7374617475732929207468726f77206e6577204572726f722827496e76616c69642053746174757327293b5c6e2020202020202020636f6e737420766963746f72203d20746869732e766963746f723b5c6e2020202020202020636f6e7374206c6f736572203d20746869732e626174746c65506c61796572732e66696e642870203d3e20702e75736572496420213d3d20766963746f722e757365724964293b5c6e2020202020202020746869732e7870203d20426174746c652e4c6576656c58505265776172645b6c6f7365722e666967687465722e6c6576656c5d3b5c6e20202020202020205c6e20202020202020206966202821766963746f722e746167732e696e636c756465732827626f74272929207b5c6e202020202020202020202020636f6e7374206974656d73203d2069737375655265776172647328746869732e646963652c20746869732e626174746c6567726f756e6454696572293b5c6e202020202020202020202020746869732e72657761726473203d206974656d732e6d61702869203d3e206e6577204679784974656d28766963746f722e666967687465722e6f776e65722c20692e6d657461646174612c20692e6974656d2c20692e7361746f7368697329293b5c6e20202020202020207d5c6e20202020202020205c6e2020202020202020746869732e626174746c65506c61796572732e666f724561636828706c61796572203d3e206e657720426174746c65546f6b656e28706c617965722e666967687465722e6f776e657229293b5c6e2020202020202020746869732e6f776e6572203d20766963746f722e666967687465722e6f776e65723b5c6e2020202020202020746869732e737461747573203d20436f6e7374616e74732e5374617475732e46696e616c697a65643b5c6e202020207d5c6e202020205c6e2020202067657453746174652829207b5c6e2020202020202020636f6e7374207374617465203d207b5c6e2020202020202020202020202e2e2e746869732e73746174652c5c6e2020202020202020202020206c6f636174696f6e3a20746869732e6f726967696e2c5c6e2020202020202020202020206f726967696e3a20746869732e6f726967696e2c5c6e2020202020202020202020206163746f723a20746869732e6163746f722c5c6e202020202020202020202020626174746c6549643a20746869732e69642c5c6e20202020202020202020202072616e646f6d3a20746869732e72616e646f6d2c5c6e2020202020202020202020207374617465486173683a20746869732e7374617465486173682c5c6e20202020202020202020202074696d657374616d703a20746869732e74696d657374616d702c5c6e2020202020202020202020207475726e436f756e743a20746869732e7475726e436f756e742c5c6e20202020202020202020202074696d656f75743a20746869732e74696d656f75742c5c6e202020202020202020202020626174746c655374617475733a20746869732e7374617475735c6e20202020202020207d3b5c6e202020202020202072657475726e2073746174653b5c6e202020207d5c6e7d222c7b224c6576656c5850526577617264223a5b302c3130302c3230302c3330302c3630302c313230302c323430302c302c302c3535362c3731332c3931332c313137302c313439382c313931392c323435382c333134382c343033322c353136342c363631342c383437325d2c224d6178526f756e6473223a3130302c2264657073223a7b22416374696f6e546f6b656e223a7b22246a6967223a307d2c22426174746c65546f6b656e223a7b22246a6967223a317d2c22426174746c655574696c73223a7b22246a6967223a327d2c22436f6e666967223a7b22246a6967223a337d2c22436f6e7374616e7473223a7b22246a6967223a347d2c2244696365223a7b22246a6967223a357d2c22467978436c617373223a7b22246a6967223a367d2c224679784974656d223a7b22246a6967223a377d2c224679784a6967223a7b22246a6967223a387d2c22536861323536223a7b22246a6967223a397d2c22657870656374223a7b22246a6967223a31307d2c22697373756552657761726473223a7b22246a6967223a31317d7d2c2268617368223a2232343231326337333838313564313331636233366430373035333962353661393835643261336530306134363166646139376237663461363834663163636630222c226d65746164617461223a7b22617070223a2243727970746f666967687473222c22656d6f6a69223a22e29a94222c226e616d65223a22426174746c65222c227075626c6973686572223a22465958227d7d5d7d5d7d11010000000000001976a91401c0211c753075df61c7ac9b25669e1799fd386e88ac869d0100000000001976a914de1bdee715a6e84d31f6bc1b9986b6a15aefc10c88ac00000000"

	tx, err := bitcoin.TxFromHex(rawTx)
	if err != nil {
		t.Fatalf("Failed to parse: %s", err)
	}

	// t.Fatalf(tx.GetTxID())
	runTx, err := run.NewFromUtxo(tx.Outputs[0])
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if runTx.AppID != cryptofights {
		t.Fatalf("Unexpected data %s", runTx.AppID)
	}

	if runTx.Payload.Exec[0].Op != run.DEPLOY {
		t.Fatalf("Failed to read Run Statement %+v", runTx.Payload.Exec[0])
	}
}

func TestSFP(t *testing.T) {

	rawTx := "0100000003b2995d99e90a1cee0f2c9d86539d53e508d2cc59fec151811b4e9658f4493648010000006b483045022100af3906d83fb489e04ff4ba7ef85a5d5bf84bbc1c157c74ab2aa4902c681f3f2902203744e68e1204f772793ee41bcf90ca7dd90cbf20362d1c5be70486c3c1b6765e4121027d900f4dea581af2dcb03fb289609e7378f52e76818383dfed6799a2e52a1235ffffffffb2995d99e90a1cee0f2c9d86539d53e508d2cc59fec151811b4e9658f4493648030000006b483045022100c5b66f4ae0ca4f2a586ceffcf9e189eb3cea9561743d5621f2cd183b3922f4a6022030fcc2717dd6a89e50c67fbe9953fdb7990c45666d1e767b953a09916b6bd22c412103b56f53068eac1277965d9aef19df92a653a2a7c72f14129769d0cfef00e2fefbffffffff67c5a6fb061ea307a88a83494eb8efb0fb651c7d58b6ad8c33577bab6423479b00000000fd2601483045022100c9e4415cde8b31c655de4500a01e4e51480732d8f64a9f611783fdba8d103d0702201d48c5d422551e43e82878b8af913219dda98d4c562f13a9fb1b6008ccb94b7c412103b5fba655473e881f30dba7139530a24b78c856c4794ff9aa8611560be6a9a7b147304402202c31c39741f1be788c9e58752d964b4f3f8c049d058b0bd3970e601f07cee41102200fa00c181a3f7f1e3be77e1f54f716b7996b0d79519fd0f30a7610ba57a510d94121038d7101680d77067b8ba7c7b964a771041d9073850f841c12d6d2e6f503a4d5ce0773667040302e31483045022100d9d56fe150d953ac296bfce20313020cea973c0ecd0492f95b7f1d1b4bcf67d202203efa0f20a2ef5870a841f30e4ee32e05bc94497d4ff0527ace50ebf5160f614f00ffffffff032202000000000000c1610773667040302e31226262626536373766346534342e6173736574406d6f6e6579627574746f6e2e636f6d14036d480462d6bc7b69b303cd6688e4bfb9e13a13142f79dc9ec5e2a054d8a02081042e4563e857337e000000005779547a75537a537a537a5679537a75527a527a5579527a75517a5479517a75615379587987695879008791695c79a9517987695d795d79ac695a79a9527987695b795b79ac77777777777777777777777777776a1102000000000000007461726765740e00002202000000000000c1610773667040302e31226262626536373766346534342e6173736574406d6f6e6579627574746f6e2e636f6d14036d480462d6bc7b69b303cd6688e4bfb9e13a1314b01de1b7530680c490ffffbe90712aad0c26c12c000000005779547a75537a537a537a5679537a75527a527a5579527a75517a5479517a75615379587987695879008791695c79a9517987695d795d79ac695a79a9527987695b795b79ac77777777777777777777777777776a1176030000000000006368616e67650e0000fc020000000000001976a9145c55261682b9fa60815bd084ae24d019c1c121e288ac00000000"

	tx, err := bitcoin.TxFromHex(rawTx)
	if err != nil {
		t.Fatalf("Failed to parse: %s", err)
	}

	sfpTx, err := sfp.NewFromUtxo(tx.Outputs[0], nil, nil)
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if sfpTx.OwnerAddress != "2f79dc9ec5e2a054d8a02081042e4563e857337e" {
		t.Fatalf("Unexpected data %s %s", sfpTx.OwnerAddress, err)
	}

	if sfpTx.Notes != "target" {
		t.Fatalf("Notes are wrong: %s", sfpTx.Notes)
	}

	sfpTx2, err := sfp.NewFromUtxo(tx.Outputs[1], nil, nil)
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if sfpTx2.OwnerAddress != "b01de1b7530680c490ffffbe90712aad0c26c12c" {
		t.Fatalf("Unexpected data 2 %s %s", sfpTx2.OwnerAddress, err)
	}

	if sfpTx2.Notes != "change" {
		t.Fatalf("Notes are wrong: %s", sfpTx2.Notes)
	}
}

func TestB(t *testing.T) {

	helloWorld := "Hello world"
	mimeType := "text/plain"
	encoding := "utf8"
	prefix := b.Prefix
	tape := bpu.Tape{
		Cell: []bpu.Cell{
			{S: &prefix},
			{S: &helloWorld},
			{S: &mimeType},
			{S: &encoding},
		},
	}
	bTx, err := b.NewFromTape(tape)
	if err != nil {
		t.Fatalf("error occurred: %s", err)
	} else if bTx.Data.UTF8 != "Hello world" {
		t.Fatalf("Unexpected data %s %s", bTx.Data.UTF8, err)
	}
}

func TestNewFromBob(t *testing.T) {
	bobTx, err := bob.NewFromString(sampleValidBobTx)
	if err != nil {
		t.Fatalf("error occurred: %s", err.Error())
	}
	var bMap *Tx
	bMap, err = NewFromBob(bobTx)
	if err != nil {
		t.Fatalf("error occurred: %s", err.Error())
	}
	if bMap.BAP.Type != bap.ATTEST {
		t.Fatalf("expected: %s but got: %s", bap.ATTEST, bMap.BAP.Type)
	}
	if bMap.AIP.Signature != "H+lubfcz5Z2oG8B7HwmP8Z+tALP+KNOPgedo7UTXwW8LBpMkgCgatCdpvbtf7wZZQSIMz83emmAvVS4S3F5X1wo=" {
		t.Fatalf("expected: %s but got: %s", "H+lubfcz5Z2oG8B7HwmP8Z+tALP+KNOPgedo7UTXwW8LBpMkgCgatCdpvbtf7wZZQSIMz83emmAvVS4S3F5X1wo=", bMap.AIP.Signature)
	}
}

func TestNewFromRawTxString(t *testing.T) {
	testHex := test.GetTestHex("./test/tx/42097dce22e3371493fe4ad63424abcf3aa31309b41a290debd3ccf7e4a6bef4.hex")
	bobTx, err := bob.NewFromRawTxString(testHex)
	if err != nil {
		t.Fatalf("error occurred: %s", err.Error())
	}
	var bMap *Tx
	bMap, err = NewFromBob(bobTx)
	if err != nil {
		t.Fatalf("error occurred: %s", err.Error())
	}
	if bMap.B.MediaType != "image/gif" {
		t.Fatalf("expected: image/gif but got: %s", bMap.B.MediaType)
	}
	if bMap.AIP.Signature != "HwGOmQsMhgz4U6EqWk2Kd5SyFMIf14sjLzTOlCBBwCvlckDAuR743e+gMUUP63letFQH7zZY3u6y6r19X35u4yA=" {
		t.Fatalf("expected: %s but got: %s", "HwGOmQsMhgz4U6EqWk2Kd5SyFMIf14sjLzTOlCBBwCvlckDAuR743e+gMUUP63letFQH7zZY3u6y6r19X35u4yA=", bMap.AIP.Signature)
	}
}
